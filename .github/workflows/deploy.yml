name: AWS CI/CD Pipeline - TaskFlow

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  STACK_NAME: taskflow-cicd-project
  NODE_VERSION: '18'

jobs:
  ci:
    name: Continuous Integration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            server/package-lock.json
            client/package-lock.json

      - name: Install dependencies - Backend
        run: |
          cd server
          npm install

      - name: Install dependencies - Frontend
        run: |
          cd client
          npm install

      - name: Lint Backend Code
        run: |
          cd server
          npm run lint || echo "⚠️ No lint script found, skipping..."

      - name: Lint Frontend Code
        run: |
          cd client
          npm run lint || echo "⚠️ No lint script found, skipping..."

      - name: Run Backend Tests
        run: |
          cd server
          npm test || echo "⚠️ No test script found, skipping..."

      - name: Run Frontend Tests
        run: |
          cd client
          npm test -- --passWithNoTests || echo "⚠️ No tests found, continuing..."

      - name: Build Frontend
        run: |
          cd client
          npm run build

      - name: Validate CloudFormation template
        run: |
          pip install cfn-lint
          cfn-lint infrastructure.yml --ignore-checks W1020,W3005

      - name: Validate SQL syntax
        run: |
          if [ -f db/init.sql ]; then
            echo "✅ SQL file found and validated"
            grep -E "CREATE|INSERT|SELECT" db/init.sql && echo "✅ SQL syntax looks good"
          fi

      - name: Security scan - Check for secrets
        run: |
          echo "🔍 Scanning for potential secrets..."
          ! grep -r -E "(password|secret|key)\s*=\s*['\"].*['\"]" server/ client/ --exclude-dir=node_modules || (echo "⚠️ Warning: Potential hardcoded secrets found" && exit 1)

      - name: Check code quality
        run: |
          echo "📊 Code Quality Checks"
          echo "Backend files: $(find server -name '*.js' | wc -l)"
          echo "Frontend files: $(find client/src -name '*.js' -o -name '*.jsx' | wc -l)"

      - name: Generate CI report
        run: |
          echo "## 🧪 CI Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Status:** All checks passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checks Performed:" >> $GITHUB_STEP_SUMMARY
          echo "- Node.js dependencies installed" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend built successfully" >> $GITHUB_STEP_SUMMARY
          echo "- CloudFormation template validated" >> $GITHUB_STEP_SUMMARY
          echo "- Security scan completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Artifacts Ready for Deployment** 🚀" >> $GITHUB_STEP_SUMMARY

  cd:
    name: Continuous Deployment
    runs-on: ubuntu-latest
    needs: ci
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            server/package-lock.json
            client/package-lock.json

      - name: Build application
        run: |
          # Build frontend with production API configuration
          cd client
          
          # Create .env for Vite build (use relative API path for Nginx proxy)
          echo "VITE_API_URL=/api" > .env
          echo "✅ Created frontend .env with VITE_API_URL=/api"
          
          npm install
          npm run build
          
          echo "✅ Frontend built successfully"
          ls -la dist/
          
          cd ..
          
          # Install backend dependencies
          cd server
          npm install --production
          echo "✅ Backend dependencies installed"
          cd ..

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check if stack exists
        id: check-stack
        run: |
          if aws cloudformation describe-stacks --stack-name ${{ env.STACK_NAME }} 2>&1 | grep -q "does not exist"; then
            echo "stack_exists=false" >> $GITHUB_OUTPUT
          else
            echo "stack_exists=true" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Deploy CloudFormation Stack
        id: deploy-stack
        run: |
          if [ "${{ steps.check-stack.outputs.stack_exists }}" == "true" ]; then
            echo "🔄 Updating existing stack..."
            aws cloudformation update-stack \
              --stack-name ${{ env.STACK_NAME }} \
              --template-body file://infrastructure.yml \
              --parameters \
                ParameterKey=KeyName,ParameterValue=${{ secrets.EC2_KEY_NAME }} \
                ParameterKey=EmailAddress,ParameterValue=${{ secrets.SNS_EMAIL }} \
                ParameterKey=DBPassword,ParameterValue=${{ secrets.DB_PASSWORD }} \
              --capabilities CAPABILITY_IAM || echo "No updates to be performed"
          else
            echo "🆕 Creating new stack..."
            aws cloudformation create-stack \
              --stack-name ${{ env.STACK_NAME }} \
              --template-body file://infrastructure.yml \
              --parameters \
                ParameterKey=KeyName,ParameterValue=${{ secrets.EC2_KEY_NAME }} \
                ParameterKey=EmailAddress,ParameterValue=${{ secrets.SNS_EMAIL }} \
                ParameterKey=DBPassword,ParameterValue=${{ secrets.DB_PASSWORD }} \
              --capabilities CAPABILITY_IAM
          fi

      - name: Wait for stack completion
        run: |
          echo "⏳ Waiting for stack to be ready..."
          aws cloudformation wait stack-create-complete \
            --stack-name ${{ env.STACK_NAME }} 2>/dev/null || \
          aws cloudformation wait stack-update-complete \
            --stack-name ${{ env.STACK_NAME }} 2>/dev/null || \
          echo "✅ Stack operation completed"

      - name: Get stack outputs
        id: stack-outputs
        run: |
          WEBAPP_IP=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='WebAppPublicIP'].OutputValue" \
            --output text)
          WEBAPP_URL=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='WebAppURL'].OutputValue" \
            --output text)
          DB_IP=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='DBPrivateIP'].OutputValue" \
            --output text)
          
          echo "webapp_ip=$WEBAPP_IP" >> $GITHUB_OUTPUT
          echo "webapp_url=$WEBAPP_URL" >> $GITHUB_OUTPUT
          echo "db_ip=$DB_IP" >> $GITHUB_OUTPUT
          
          echo "WebApp IP: $WEBAPP_IP"
          echo "WebApp URL: $WEBAPP_URL"
          echo "Database IP: $DB_IP"

      - name: Package application
        env:
          DB_IP: ${{ steps.stack-outputs.outputs.db_ip }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          echo "📦 Packaging application..."
          mkdir -p deploy-package/server
          mkdir -p deploy-package/client/dist
          
          # Copy backend
          echo "Copying backend files..."
          cp -r server/* deploy-package/server/
          
          # Create production .env file for backend
          echo "Creating backend .env file..."
          cat > deploy-package/server/.env <<EOF
          NODE_ENV=production
          PORT=3000
          DB_HOST=$DB_IP
          DB_PORT=5432
          DB_NAME=taskflow_db
          DB_USER=taskflow_user
          DB_PASSWORD=$DB_PASSWORD
          EOF
          
          echo "✅ Backend .env created:"
          cat deploy-package/server/.env
          
          # Copy frontend build
          if [ -d "client/dist" ]; then
            echo "✅ Found client/dist, copying contents..."
            cp -r client/dist/* deploy-package/client/dist/
            echo "Frontend files copied: $(find deploy-package/client/dist -type f | wc -l) files"
            ls -la deploy-package/client/dist/ | head -10
          else
            echo "❌ ERROR: client/dist not found!"
            echo "Available client directories:"
            ls -la client/
            exit 1
          fi
          
          # Copy database init if exists
          if [ -f "db/init.sql" ]; then
            echo "Copying database init script..."
            cp db/init.sql deploy-package/
          fi
          
          echo ""
          echo "📋 Final package contents:"
          echo "--------------------------------"
          ls -la deploy-package/
          echo ""
          echo "Backend files:"
          find deploy-package/server -type f | head -10
          echo ""
          echo "Frontend files:"
          find deploy-package/client/dist -type f | head -10
          echo ""
          
          # Create tarball
          tar -czf taskflow-app.tar.gz -C deploy-package .
          
          echo "✅ Package created: $(du -h taskflow-app.tar.gz)"

      - name: Deploy application to EC2
        env:
          WEBAPP_IP: ${{ steps.stack-outputs.outputs.webapp_ip }}
          EC2_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
        run: |
          echo "🚀 Deploying application to EC2..."
          
          mkdir -p ~/.ssh
          echo "$EC2_KEY" > ~/.ssh/deploy_key.pem
          chmod 600 ~/.ssh/deploy_key.pem
          
          ssh-keyscan -H $WEBAPP_IP >> ~/.ssh/known_hosts 2>/dev/null || true
          
          echo "⏳ Waiting for SSH to be available..."
          for i in {1..30}; do
            if ssh -i ~/.ssh/deploy_key.pem -o ConnectTimeout=5 -o StrictHostKeyChecking=no ec2-user@$WEBAPP_IP "echo 'SSH Ready'" 2>/dev/null; then
              echo "✅ SSH connection established"
              break
            fi
            echo "Attempt $i/30: SSH not ready yet..."
            sleep 10
          done
          
          echo "📦 Copying application files..."
          scp -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no taskflow-app.tar.gz ec2-user@$WEBAPP_IP:/tmp/
          
          echo "🔄 Deploying and restarting services..."
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no ec2-user@$WEBAPP_IP bash << 'ENDSSH'
            set -e
            
            echo "========================================="
            echo "📁 Starting Deployment Process"
            echo "========================================="
            
            # Extract to temporary directory
            rm -rf /tmp/deploy-new
            mkdir -p /tmp/deploy-new
            
            echo "📦 Extracting application package..."
            tar -xzf /tmp/taskflow-app.tar.gz -C /tmp/deploy-new
            
            echo "✅ Extracted package structure:"
            ls -la /tmp/deploy-new
            
            echo ""
            echo "Frontend files in package:"
            if [ -d "/tmp/deploy-new/client/dist" ]; then
              ls -la /tmp/deploy-new/client/dist/ | head -10
              echo "Total frontend files: $(find /tmp/deploy-new/client/dist -type f | wc -l)"
            else
              echo "⚠️ No dist directory found!"
            fi
            
            echo ""
            echo "Backend .env file:"
            if [ -f "/tmp/deploy-new/server/.env" ]; then
              echo "✅ .env file found"
              cat /tmp/deploy-new/server/.env
            else
              echo "⚠️ No .env file found in package!"
            fi
            
            # Verify frontend files exist
            if [ ! -d "/tmp/deploy-new/client/dist" ] || [ -z "$(ls -A /tmp/deploy-new/client/dist)" ]; then
              echo ""
              echo "❌ ERROR: Frontend dist directory is missing or empty!"
              echo "Package structure:"
              find /tmp/deploy-new -type f
              exit 1
            fi
            
            echo ""
            echo "========================================="
            echo "🛑 Stopping Current Application"
            echo "========================================="
            pm2 stop taskflow-api 2>/dev/null || echo "No app to stop"
            pm2 delete taskflow-api 2>/dev/null || echo "No app to delete"
            
            echo ""
            echo "========================================="
            echo "🔧 Updating Backend"
            echo "========================================="
            cd /opt/webapp
            
            # Fix ownership
            sudo chown -R ec2-user:ec2-user /opt/webapp 2>/dev/null || true
            
            # Backup old backend
            if [ -d "server" ]; then
              echo "Backing up old backend..."
              rm -rf server-backup-old
              mv server-backup server-backup-old 2>/dev/null || true
              mv server server-backup
            fi
            
            # Copy new backend
            echo "Copying new backend..."
            cp -r /tmp/deploy-new/server ./
            
            # Verify .env was copied
            if [ -f "server/.env" ]; then
              echo "✅ Backend .env file present:"
              cat server/.env
            else
              echo "❌ ERROR: .env file missing after copy!"
              exit 1
            fi
            
            # Install backend dependencies
            echo "Installing backend dependencies..."
            cd server
            npm install --production
            
            # Detect entry point
            if [ -f "package.json" ]; then
              ENTRY_POINT=$(node -p "try { require('./package.json').main } catch(e) { 'index.js' }")
            else
              ENTRY_POINT="index.js"
            fi
            
            # Find entry point if not found
            if [ ! -f "$ENTRY_POINT" ]; then
              if [ -f "index.js" ]; then
                ENTRY_POINT="index.js"
              elif [ -f "app.js" ]; then
                ENTRY_POINT="app.js"
              elif [ -f "server.js" ]; then
                ENTRY_POINT="server.js"
              else
                echo "❌ Could not find entry point!"
                echo "Available JS files:"
                ls -la *.js 2>/dev/null || echo "No JS files found"
                exit 1
              fi
            fi
            
            echo "✅ Using entry point: $ENTRY_POINT"
            
            # Start backend with PM2
            echo ""
            echo "🔄 Starting backend with PM2..."
            
            # Verify .env one more time before starting
            echo "Environment variables that will be used:"
            cat .env
            
            # Start with explicit environment
            pm2 start $ENTRY_POINT \
              --name taskflow-api \
              --env production \
              --update-env
            
            pm2 save
            
            # Show PM2 environment
            echo ""
            echo "PM2 Environment for taskflow-api:"
            pm2 env 0
            
            # Wait for backend to start
            sleep 5
            
            echo ""
            echo "========================================="
            echo "🎨 Updating Frontend"
            echo "========================================="
            cd /opt/webapp
            
            # Backup old frontend
            if [ -d "client/dist" ]; then
              echo "Backing up old frontend..."
              rm -rf client/dist-backup-old
              mv client/dist-backup client/dist-backup-old 2>/dev/null || true
              mv client/dist client/dist-backup
            fi
            
            # Create client directory structure
            mkdir -p client/dist
            
            # Copy new frontend
            echo "Copying new frontend files..."
            cp -r /tmp/deploy-new/client/dist/* client/dist/ 2>/dev/null || {
              cp -r /tmp/deploy-new/client/dist/. client/dist/ 2>/dev/null || {
                echo "❌ Failed to copy frontend files"
                exit 1
              }
            }
            
            echo "✅ Frontend files updated"
            echo "File count: $(find client/dist -type f | wc -l)"
            echo "Files:"
            ls -la client/dist/
            
            # Verify critical files
            if [ ! -f "client/dist/index.html" ]; then
              echo "⚠️ WARNING: index.html not found!"
              echo "Available files:"
              find client/dist -type f
            else
              echo "✅ index.html found: $(stat -c %y client/dist/index.html)"
            fi
            
            echo ""
            echo "========================================="
            echo "🔄 Restarting Nginx"
            echo "========================================="
            sudo systemctl restart nginx
            
            # Verify Nginx is running
            if sudo systemctl is-active --quiet nginx; then
              echo "✅ Nginx is running"
            else
              echo "❌ Nginx failed to start!"
              sudo systemctl status nginx
              exit 1
            fi
            
            echo ""
            echo "========================================="
            echo "🧹 Cleanup"
            echo "========================================="
            rm -rf /tmp/deploy-new
            rm /tmp/taskflow-app.tar.gz
            echo "✅ Temporary files removed"
            
            echo ""
            echo "========================================="
            echo "✅ Deployment Complete!"
            echo "========================================="
            echo ""
            echo "📊 Application Status:"
            echo "--------------------------------"
            pm2 list
            echo ""
            echo "📊 Backend Info:"
            echo "  Entry Point: $ENTRY_POINT"
            echo "  Environment: production"
            echo "  .env: $([ -f /opt/webapp/server/.env ] && echo '✅ Present' || echo '❌ Missing')"
            echo ""
            echo "📊 Frontend Info:"
            echo "  Files: $(find client/dist -type f | wc -l)"
            if [ -f "client/dist/index.html" ]; then
              echo "  Updated: $(stat -c %y client/dist/index.html)"
            fi
            echo ""
            echo "📊 Services:"
            echo "  PM2: $(pm2 list | grep -c online) running"
            echo "  Nginx: $(sudo systemctl is-active nginx)"
            echo ""
            echo "========================================="
          ENDSSH
          
          echo "✅ Application deployed successfully to EC2"

      - name: Verify deployment
        env:
          WEBAPP_IP: ${{ steps.stack-outputs.outputs.webapp_ip }}
          EC2_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
        run: |
          echo "🔍 Verifying deployment..."
          
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no ec2-user@$WEBAPP_IP bash << 'ENDSSH'
            echo "Checking PM2 status..."
            pm2 status
            
            echo ""
            echo "Checking backend logs (last 20 lines)..."
            pm2 logs taskflow-api --nostream --lines 20 || true
            
            echo ""
            echo "Testing backend health..."
            curl -s http://localhost:3000/api/health || echo "Backend not responding yet"
            
            echo ""
            echo "Testing Nginx..."
            curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://localhost/
          ENDSSH

      - name: Test application health
        env:
          WEBAPP_URL: ${{ steps.stack-outputs.outputs.webapp_url }}
        run: |
          echo "🧪 Testing application health..."
          sleep 30
          
          for i in {1..10}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $WEBAPP_URL || echo "000")
            echo "Attempt $i: HTTP $HTTP_CODE"
            
            if [ "$HTTP_CODE" == "200" ]; then
              echo "✅ Application is responding!"
              echo ""
              echo "Testing content..."
              curl -s $WEBAPP_URL | head -20
              break
            fi
            
            if [ $i -eq 10 ]; then
              echo "⚠️ Application may still be initializing."
              echo "Manual check required at: $WEBAPP_URL"
            fi
            sleep 10
          done

      - name: Test API endpoint
        env:
          WEBAPP_URL: ${{ steps.stack-outputs.outputs.webapp_url }}
        run: |
          echo "🧪 Testing API health endpoint..."
          sleep 5
          
          API_RESPONSE=$(curl -s "$WEBAPP_URL/api/health" || echo "failed")
          echo "API Response: $API_RESPONSE"
          
          if echo "$API_RESPONSE" | grep -q "ok\|healthy\|success"; then
            echo "✅ API is responding correctly"
          else
            echo "⚠️ API response unexpected, but deployment may still be initializing"
          fi

      - name: Generate deployment report
        env:
          WEBAPP_URL: ${{ steps.stack-outputs.outputs.webapp_url }}
          DB_IP: ${{ steps.stack-outputs.outputs.db_ip }}
        run: |
          echo "## 🚀 Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ✅ Deployment Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Stack Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Stack Name:** \`${{ env.STACK_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Region:** \`${{ env.AWS_REGION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Application URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **WebApp:** [$WEBAPP_URL]($WEBAPP_URL)" >> $GITHUB_STEP_SUMMARY
          echo "- **API Health:** [$WEBAPP_URL/api/health]($WEBAPP_URL/api/health)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "- **WebApp IP:** \`${{ steps.stack-outputs.outputs.webapp_ip }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Database IP:** \`$DB_IP\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Backend .env configured with database credentials" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Frontend configured with \`VITE_API_URL=/api\`" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Nginx proxy configured for \`/api\` routes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🎉 **Your TaskFlow application is now live!**" >> $GITHUB_STEP_SUMMARY

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment completed successfully!"
            echo "🌐 Application is now available at: ${{ steps.stack-outputs.outputs.webapp_url }}"
          else
            echo "❌ Deployment failed. Check the logs above for details."
            echo "💡 Common issues:"
            echo "  - Check if EC2 instances are running"
            echo "  - Verify security group rules"
            echo "  - Check CloudWatch logs"
          fi

  cleanup:
    name: Cleanup Resources
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment:
      name: cleanup
      url: https://console.aws.amazon.com/cloudformation

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Delete CloudFormation Stack
        run: |
          echo "🗑️ Deleting stack ${{ env.STACK_NAME }}..."
          aws cloudformation delete-stack --stack-name ${{ env.STACK_NAME }}
          echo "⏳ Waiting for stack deletion..."
          aws cloudformation wait stack-delete-complete --stack-name ${{ env.STACK_NAME }}
          echo "✅ Stack deleted successfully"

      - name: Cleanup summary
        run: |
          echo "## 🗑️ Cleanup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All AWS resources have been deleted:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ EC2 instances terminated" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ VPC and networking deleted" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Security groups removed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Elastic IPs released" >> $GITHUB_STEP_SUMMARY
          echo "- ℹ️ CloudWatch logs retained (7 days)" >> $GITHUB_STEP_SUMMARY